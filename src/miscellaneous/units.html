<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* miscellaneous/units.html */
    body[data-page="miscellaneous-units"] {
          --bg:#0e0f12; --panel:#151720; --muted:#8b93a7; --text:#e8ecf3; --accent:#69d2ff;
          --bad:#ff6b6b; --ok:#ffd166; --good:#06d6a0; --card:#1b1f2b; --chip:#23283a;
        }
    body[data-page="miscellaneous-units"] * {box-sizing:border-box}
    body[data-page="miscellaneous-units"] html, body[data-page="miscellaneous-units"] {height:100%}
    body[data-page="miscellaneous-units"] {
          margin:0; font:500 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
          color:var(--text); background:linear-gradient(180deg,#0b0c10, var(--bg) 20%);
        }
    body[data-page="miscellaneous-units"] .wrap {max-width:1100px;margin:0 auto;padding:24px}
    body[data-page="miscellaneous-units"] header {display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:18px}
    body[data-page="miscellaneous-units"] h1 {font-size:20px;letter-spacing:.3px;margin:0}
    body[data-page="miscellaneous-units"] .subtitle {color:var(--muted);font-size:13px}
    body[data-page="miscellaneous-units"] .card {background:var(--panel);border:1px solid #1d2234;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    body[data-page="miscellaneous-units"] .row {display:grid;gap:12px}
    body[data-page="miscellaneous-units"] .controls {display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr auto;gap:12px;align-items:end;padding:16px;border-bottom:1px solid var(--text)83b}
    body[data-page="miscellaneous-units"] .controls label {font-size:12px;color:var(--muted)}
    body[data-page="miscellaneous-units"] .controls input, body[data-page="miscellaneous-units"] .controls select {
          width:100%; padding:10px 12px; border-radius:10px; border:1px solid #232a3f; background:var(--card); color:var(--text);
          outline:none; transition:border .15s ease, box-shadow .15s ease;
        }
    body[data-page="miscellaneous-units"] .controls input:focus, body[data-page="miscellaneous-units"] .controls select:focus {border-color:#2b375c; box-shadow:0 0 0 3px rgba(105,210,255,.15)}
    body[data-page="miscellaneous-units"] .controls .stack {display:flex;flex-direction:column;gap:6px}
    body[data-page="miscellaneous-units"] .btn {appearance:none;border:1px solid #2a344f;background:linear-gradient(180deg,#1f2536,#181c2a);color:var(--text);
          padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;letter-spacing:.2px}
    body[data-page="miscellaneous-units"] .btn:hover {border-color:#334066}
    body[data-page="miscellaneous-units"] .btn-primary {background:linear-gradient(180deg,#3a7bd5,#00d2ff);color:#051018;border:0}
    body[data-page="miscellaneous-units"] .btn-ghost {background:transparent;border:1px dashed #2a344f;color:var(--muted)}
    body[data-page="miscellaneous-units"] .grid {display:grid;grid-template-columns:1fr;}
    @media(min-width:880px){
    body[data-page="miscellaneous-units"] .grid {grid-template-columns: 2.1fr 1fr}
    }
    body[data-page="miscellaneous-units"] .panel {padding:16px}
    body[data-page="miscellaneous-units"] .results {max-height:52vh;overflow:auto}
    body[data-page="miscellaneous-units"] table {width:100%;border-collapse:separate;border-spacing:0}
    body[data-page="miscellaneous-units"] th, body[data-page="miscellaneous-units"] td {padding:12px 10px;border-bottom:1px solid var(--text)83b;vertical-align:middle}
    body[data-page="miscellaneous-units"] thead th {position:sticky;top:0;background:linear-gradient(180deg,#1b2030, #181c2a);z-index:2}
    body[data-page="miscellaneous-units"] tbody tr:hover {background:#161a27}
    body[data-page="miscellaneous-units"] .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    body[data-page="miscellaneous-units"] .pill {display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid #2a314b;color:#b3bdd7;font-size:12px}
    body[data-page="miscellaneous-units"] .right {display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    body[data-page="miscellaneous-units"] .small {font-size:12px;color:var(--muted)}
    body[data-page="miscellaneous-units"] .footer {margin-top:16px;color:var(--muted);font-size:12px}
    body[data-page="miscellaneous-units"] .badge {background:#122f3a;color:#8ce4ff;border:1px solid #1c4454;border-radius:8px;padding:2px 6px;font-size:12px}
    body[data-page="miscellaneous-units"] .fav {cursor:pointer}
    body[data-page="miscellaneous-units"] .notice {padding:10px 12px;border-radius:10px;background:#132018;border:1px solid #1f3b2c;color:#a9e7c6;font-size:13px}
    body[data-page="miscellaneous-units"] .danger {background:#2a1a1a;border-color:#513030;color:#ffb3b3}
    body[data-page="miscellaneous-units"] .inline {display:inline-block}
    body[data-page="miscellaneous-units"] .muted {color:var(--muted)}
    body[data-page="miscellaneous-units"] .unit-search {display:flex;gap:8px;align-items:center}
    body[data-page="miscellaneous-units"] .unit-search input {flex:1}
    body[data-page="miscellaneous-units"] .chips {display:flex;gap:8px;flex-wrap:wrap}
    body[data-page="miscellaneous-units"] .section-title {display:flex;align-items:center;gap:10px;margin:0 0 6px 0}
  </style>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Universal Construction Unit Converter</title>
</head>
<body data-page="miscellaneous-units">
  <div class="wrap">
    <header>
      <div>
        <h1>Universal Construction Unit Converter</h1>
        <div class="subtitle">Field-ready, offline, and fast. Covers typical construction/engineering unit families.</div>
      </div>
      <div class="right">
        <span class="pill">Precision: <span id="precView" class="mono">4</span> sig figs</span>
        <button id="decPrec" class="btn" title="Decrease precision">−</button>
        <button id="incPrec" class="btn" title="Increase precision">+</button>
        <button id="addRow" class="btn">Add line</button>
        <button id="clearRows" class="btn btn-ghost">Clear</button>
      </div>
    </header>

    <div class="card grid">
      <div class="panel">
        <div class="controls">
          <div class="stack">
            <label for="value">Value</label>
            <input id="value" type="number" step="any" inputmode="decimal" placeholder="Enter a value (e.g., 12.5)" />
          </div>
          <div class="stack">
            <label for="category">Category</label>
            <select id="category"></select>
          </div>
          <div class="stack">
            <label for="fromUnit">From</label>
            <select id="fromUnit"></select>
          </div>
          <div class="stack">
            <label for="toUnit">To</label>
            <select id="toUnit"></select>
          </div>
          <div>
            <button id="convert" class="btn btn-primary" style="width:100%">Convert</button>
          </div>
        </div>

        <div class="panel">
          <div class="section-title">
            <strong>Quick Unit Search</strong>
            <span class="badge">Power-user</span>
          </div>
          <div class="unit-search">
            <input id="search" type="text" placeholder="Search units (e.g., psi, inH2O, kip, tonR, cfm, pcf, °F)" />
            <button id="swap" class="btn" title="Swap From/To">⇄ Swap</button>
            <button id="star" class="btn fav" title="Toggle favorite pair">★</button>
          </div>
          <div class="chips" id="favorites" style="margin-top:8px"></div>
        </div>

        <div class="panel notice" id="note"></div>
      </div>

      <div class="panel" style="border-left:1px solid #22283b">
        <div class="section-title"><strong>Batch Lines</strong><span class="badge">Multi</span></div>
        <div class="small muted" style="margin-bottom:8px">Add multiple conversions for copy/paste into takeoffs, RFIs, or emails.</div>
        <div class="results">
          <table id="lines">
            <thead>
              <tr>
                <th style="width:28%">Input</th>
                <th style="width:20%">From</th>
                <th style="width:20%">To</th>
                <th style="width:24%">Result</th>
                <th style="width:8%"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="right" style="margin-top:10px">
          <button id="copyAll" class="btn">Copy all</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Tip: Temperature, angle, and slope use affine/non-linear formulas; others use exact SI-base factors. Density uses kg/m³ base; flow uses m³/s; pressure uses Pa.</div>
      <div style="margin-top:6px" class="muted">Designed for construction & engineering: length, area, volume, mass, force, pressure, temperature, energy, power, volumetric flow, velocity, density, torque, angle/slope. Includes psi, psf, inH₂O (4 °C), inHg, kip, TR (tons of refrigeration), BTU, cfm, gpm, pcf, and more.</div>
    </div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const note = msg => { const n = $('#note'); n.textContent = msg || ''; n.className = 'panel ' + (msg ? 'notice' : ''); };

  // -------- Unit Catalog --------
  const deg = Math.PI/180;
  function u(sym, name, toBase, fromBase, affine=false){ return {sym, name, toBase, fromBase, affine}; }

  const Units = {
    Length: {
      base: 'm',
      units: [
        u('mm','Millimeter', v=>v/1000, v=>v*1000),
        u('cm','Centimeter', v=>v/100, v=>v*100),
        u('m','Meter', v=>v, v=>v),
        u('km','Kilometer', v=>v*1000, v=>v/1000),
        u('in','Inch', v=>v*0.0254, v=>v/0.0254),
        u('ft','Foot', v=>v*0.3048, v=>v/0.3048),
        u('yd','Yard', v=>v*0.9144, v=>v/0.9144),
        u('mi','Mile', v=>v*1609.344, v=>v/1609.344)
      ]
    },
    Area: {
      base: 'm²',
      units: [
        u('mm²','Square Millimeter', v=>v/1e6, v=>v*1e6),
        u('cm²','Square Centimeter', v=>v/1e4, v=>v*1e4),
        u('m²','Square Meter', v=>v, v=>v),
        u('ha','Hectare', v=>v*1e4, v=>v/1e4),
        u('km²','Square Kilometer', v=>v*1e6, v=>v/1e6),
        u('in²','Square Inch', v=>v*0.00064516, v=>v/0.00064516),
        u('ft²','Square Foot', v=>v*0.09290304, v=>v/0.09290304),
        u('yd²','Square Yard', v=>v*0.83612736, v=>v/0.83612736),
        u('ac','Acre', v=>v*4046.8564224, v=>v/4046.8564224)
      ]
    },
    Volume: {
      base: 'm³',
      units: [
        u('mL','Milliliter', v=>v/1e6, v=>v*1e6),
        u('L','Liter', v=>v/1000, v=>v*1000),
        u('m³','Cubic Meter', v=>v, v=>v),
        u('in³','Cubic Inch', v=>v*1.6387064e-5, v=>v/1.6387064e-5),
        u('ft³','Cubic Foot', v=>v*0.028316846592, v=>v/0.028316846592),
        u('yd³','Cubic Yard', v=>v*0.764554857984, v=>v/0.764554857984),
        u('gal','US Gallon', v=>v*0.003785411784, v=>v/0.003785411784),
        u('qt','US Quart', v=>v*0.000946352946, v=>v/0.000946352946),
        u('pt','US Pint', v=>v*0.000473176473, v=>v/0.000473176473),
        { sym:'bf', name:'Board Foot', toBase:v=> v * (144 * 1.6387064e-5), fromBase:v=> v / (144 * 1.6387064e-5) }
      ]
    },
    Mass: {
      base: 'kg',
      units: [
        u('g','Gram', v=>v/1000, v=>v*1000),
        u('kg','Kilogram', v=>v, v=>v),
        u('t','Metric Tonne', v=>v*1000, v=>v/1000),
        u('oz','Ounce (avdp)', v=>v*0.028349523125, v=>v/0.028349523125),
        u('lb','Pound (lbm)', v=>v*0.45359237, v=>v/0.45359237),
        u('ton (US)','Short Ton (US)', v=>v*907.18474, v=>v/907.18474),
        u('ton (UK)','Long Ton (UK)', v=>v*1016.0469088, v=>v/1016.0469088)
      ]
    },
    Force: {
      base: 'N',
      units: [
        u('N','Newton', v=>v, v=>v),
        u('kN','Kilonewton', v=>v*1000, v=>v/1000),
        u('lbf','Pound-force', v=>v*4.4482216152605, v=>v/4.4482216152605),
        u('kip','Kip', v=>v*4448.2216152605, v=>v/4448.2216152605)
      ]
    },
    Pressure: {
      base: 'Pa',
      units: [
        u('Pa','Pascal', v=>v, v=>v),
        u('kPa','Kilopascal', v=>v*1000, v=>v/1000),
        u('MPa','Megapascal', v=>v*1e6, v=>v/1e6),
        u('bar','Bar', v=>v*1e5, v=>v/1e5),
        u('atm','Atmosphere', v=>v*101325, v=>v/101325),
        u('torr','Torr (mmHg)', v=>v*133.322368, v=>v/133.322368),
        u('psi','Pound per sq in', v=>v*6894.757293168, v=>v/6894.757293168),
        u('psf','Pound per sq ft', v=>v*47.88025898033584, v=>v/47.88025898033584),
        u('inH2O','inches of water (4°C)', v=>v*249.08891, v=>v/249.08891),
        u('inHg','inches of mercury (0°C)', v=>v*3386.389, v=>v/3386.389)
      ]
    },
    Temperature: {
      base: 'K',
      units: [
        { sym:'°C', name:'Celsius', toBase:v=>v+273.15, fromBase:v=>v-273.15, affine:true },
        { sym:'K', name:'Kelvin', toBase:v=>v, fromBase:v=>v, affine:true },
        { sym:'°F', name:'Fahrenheit', toBase:v=>(v-32)*5/9+273.15, fromBase:v=> (v-273.15)*9/5+32, affine:true }
      ]
    },
    Energy: {
      base: 'J',
      units: [
        u('J','Joule', v=>v, v=>v),
        u('kJ','Kilojoule', v=>v*1000, v=>v/1000),
        u('MJ','Megajoule', v=>v*1e6, v=>v/1e6),
        u('Wh','Watt-hour', v=>v*3600, v=>v/3600),
        u('kWh','Kilowatt-hour', v=>v*3.6e6, v=>v/3.6e6),
        u('BTU','BTU (IT)', v=>v*1055.056, v=>v/1055.056),
        u('therm','Therm (US)', v=>v*105505585.257348, v=>v/105505585.257348)
      ]
    },
    Power: {
      base: 'W',
      units: [
        u('W','Watt', v=>v, v=>v),
        u('kW','Kilowatt', v=>v*1000, v=>v/1000),
        u('MW','Megawatt', v=>v*1e6, v=>v/1e6),
        u('hp','Horsepower (mech)', v=>v*745.6998715822702, v=>v/745.6998715822702),
        u('tonR','Ton Refrigeration', v=>v*3516.8528420667, v=>v/3516.8528420667),
        u('BTU/h','BTU per hour', v=>v*1055.056/3600, v=>v/(1055.056/3600)),
        { sym:'MBH', name:'MBH (1k BTU/h)', toBase:v=> (v*1000)*1055.056/3600, fromBase:v=> (v/(1055.056/3600))/1000 }
      ]
    },
    'Apparent Power': {
      base: 'VA',
      units: [
        u('VA','Volt-ampere', v=>v, v=>v),
        u('kVA','Kilovolt-ampere', v=>v*1000, v=>v/1000),
        u('MVA','Megavolt-ampere', v=>v*1e6, v=>v/1e6)
      ]
    },
    'Volumetric Flow': {
      base: 'm³/s',
      units: [
        u('m³/s','Cubic meter/sec', v=>v, v=>v),
        u('L/s','Liter/sec', v=>v/1000, v=>v*1000),
        u('m³/h','Cubic meter/hour', v=>v/3600, v=>v*3600),
        u('cfm','Cubic foot/min', v=>v*0.000471947443, v=>v/0.000471947443),
        u('gpm','US gallon/min', v=>v*6.30901964e-5, v=>v/6.30901964e-5),
        u('scfm','Std cubic ft/min', v=>v*0.000471947443, v=>v/0.000471947443)
      ]
    },
    Velocity: {
      base: 'm/s',
      units: [
        u('m/s','Meters/sec', v=>v, v=>v),
        u('km/h','Kilometers/hour', v=>v/3.6, v=>v*3.6),
        u('ft/s','Feet/sec', v=>v*0.3048, v=>v/0.3048),
        u('fpm','Feet/min', v=>v*0.00508, v=>v/0.00508),
        u('mph','Miles/hour', v=>v*0.44704, v=>v/0.44704),
        u('kn','Knots', v=>v*0.514444, v=>v/0.514444)
      ]
    },
    Density: {
      base: 'kg/m³',
      units: [
        u('kg/m³','Kilogram/m³', v=>v, v=>v),
        u('g/cm³','Gram/cm³', v=>v*1000, v=>v/1000),
        u('lb/ft³','Pound/ft³ (pcf)', v=>v*16.01846337396, v=>v/16.01846337396),
        u('lb/in³','Pound/in³', v=>v*27679.904710191, v=>v/27679.904710191),
        u('lb/gal','Pound/US gallon', v=>v*119.826427316, v=>v/119.826427316)
      ]
    },
    'Linear Density': {
      base: 'kg/m',
      units: [
        u('kg/m','Kilogram per meter', v=>v, v=>v),
        u('lb/ft','Pound per foot', v=>v*1.48816394357, v=>v/1.48816394357),
        u('lb/in','Pound per inch', v=>v*17.8579673228, v=>v/17.8579673228)
      ]
    },
    Torque: {
      base: 'N·m',
      units: [
        u('N·m','Newton·meter', v=>v, v=>v),
        u('kN·m','Kilonewton·meter', v=>v*1000, v=>v/1000),
        u('ft·lbf','Foot·pound', v=>v*1.3558179483314, v=>v/1.3558179483314),
        u('in·lbf','Inch·pound', v=>v*0.1129848290276167, v=>v/0.1129848290276167)
      ]
    },
    'Angle / Slope': {
      base: 'rad',
      units: [
        u('rad','Radian', v=>v, v=>v, true),
        u('°','Degree', v=>v*deg, v=>v/deg, true),
        { sym:'% grade', name:'Percent Grade', affine:true, toBase:(v)=>Math.atan(v/100), fromBase:(r)=>Math.tan(r)*100 },
        { sym:'in/ft', name:'Inches per foot', affine:true, toBase:(v)=>Math.atan((v)/12), fromBase:(r)=>Math.tan(r)*12 }
      ]
    },
    'Thermal Resistance (R/RSI)': {
      base: 'm²·K/W',
      units: [
        u('RSI','m²·K/W (SI R)', v=>v, v=>v),
        { sym:'R', name:'hr·ft²·°F/BTU', toBase:v=>v*0.1761101838, fromBase:v=>v/0.1761101838 }
      ]
    },
    'Thermal Transmittance (U)': {
      base: 'W/m²·K',
      units: [
        u('W/m²·K','SI U-factor', v=>v, v=>v),
        { sym:'BTU/(h·ft²·°F)', name:'IP U-factor', toBase:v=>v*5.678263, fromBase:v=>v/5.678263 }
      ]
    }
  };

  // Build UI options
  const catSel = $('#category');
  const fromSel = $('#fromUnit');
  const toSel = $('#toUnit');

  Object.keys(Units).forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = cat; catSel.appendChild(opt);
  });

  function loadUnits(cat){
    fromSel.innerHTML=''; toSel.innerHTML='';
    Units[cat].units.forEach(({sym,name})=>{
      const o1=document.createElement('option'); o1.value=sym; o1.textContent = `${sym} — ${name}`; fromSel.appendChild(o1);
      const o2=document.createElement('option'); o2.value=sym; o2.textContent = `${sym} — ${name}`; toSel.appendChild(o2);
    });
    const defaults = {
      Length:['ft','m'], Area:['ft²','m²'], Volume:['bf','ft³'], Mass:['lb','kg'], Force:['lbf','kN'],
      Pressure:['psi','kPa'], Temperature:['°F','°C'], Energy:['BTU','kWh'], Power:['MBH','kW'],
      'Apparent Power':['kVA','kVA'], 'Volumetric Flow':['cfm','L/s'], Velocity:['fpm','m/s'], Density:['lb/ft³','kg/m³'],
      'Linear Density':['lb/ft','kg/m'], Torque:['ft·lbf','N·m'], 'Angle / Slope':['in/ft','°'],
      'Thermal Resistance (R/RSI)':['R','RSI'], 'Thermal Transmittance (U)':['BTU/(h·ft²·°F)','W/m²·K']
    };
    const d = defaults[cat] || [];
    if(d[0]) fromSel.value = d[0];
    if(d[1]) toSel.value = d[1];
  }

  // precision handling
  let sigFigs = Number(localStorage.getItem('uc_sigfigs')||'4');
  const setPrec = n => { sigFigs = Math.max(2, Math.min(12, n|0)); $('#precView').textContent = sigFigs; localStorage.setItem('uc_sigfigs', sigFigs); };
  setPrec(sigFigs);

  // favorites
  let favorites = JSON.parse(localStorage.getItem('uc_favs')||'[]');
  function favKey(cat, from, to){ return `${cat}|${from}>${to}`; }
  function isFav(cat, from, to){ return favorites.includes(favKey(cat,from,to)); }
  function toggleFav(){
    const k = favKey(catSel.value, fromSel.value, toSel.value);
    const i = favorites.indexOf(k);
    if(i>=0) favorites.splice(i,1); else favorites.push(k);
    localStorage.setItem('uc_favs', JSON.stringify(favorites));
    renderFavs();
    paintStar();
  }
  function paintStar(){ $('#star').style.opacity = isFav(catSel.value, fromSel.value, toSel.value) ? '1' : '.55'; }
  function renderFavs(){
    const box = $('#favorites'); box.innerHTML='';
    if(!favorites.length){
      const span = document.createElement('span'); span.className='small muted'; span.textContent='No favorites yet. Click ★ to save current pair.'; box.appendChild(span); return;
    }
    favorites.slice(0,30).forEach(k=>{
      const [cat, flow] = k.split('|');
      const [from,to] = flow.split('>');
      const chip = document.createElement('button');
      chip.className='pill'; chip.title='Use favorite';
      chip.textContent = `${cat}: ${from} → ${to}`;
      chip.onclick=()=>{ catSel.value=cat; loadUnits(cat); fromSel.value=from; toSel.value=to; paintStar(); };
      box.appendChild(chip);
    });
  }

  // search
  function searchUnits(q){
    q = q.trim().toLowerCase();
    if(!q){ note(''); return; }
    const hits=[];
    for(const [cat,def] of Object.entries(Units)){
      def.units.forEach(u=>{
        const hay = `${u.sym} ${u.name}`.toLowerCase();
        if(hay.includes(q)) hits.push({cat, sym:u.sym, name:u.name});
      });
    }
    if(!hits.length){ note('No matching units.'); return; }
    const top = hits[0];
    note(`Found ${hits.length} matches. Focused: ${top.cat} — ${top.sym} (${top.name}).`);
    catSel.value = top.cat; loadUnits(top.cat); fromSel.value = top.sym; paintStar();
  }

  // conversion core
  function getUnit(cat, sym){ return Units[cat].units.find(u=>u.sym===sym); }

  function convertOnce(val, cat, from, to){
    const f = getUnit(cat, from); const t = getUnit(cat, to);
    if(!f||!t) throw new Error('Unit not found');
    const baseVal = f.toBase(val);
    const out = t.fromBase(baseVal);
    return out;
  }

  function fmt(x){
    if(!isFinite(x)) return '—';
    const ax = Math.abs(x);
    if(ax===0) return '0';
    const digits = sigFigs;
    let s = (ax>=1e6 || ax<1e-3) ? x.toExponential(digits-1) : x.toPrecision(digits);
    return s; // keep literal exponent without regex cleanup to avoid escape complexity in this single-file build
  }

  function addLine(val, cat, from, to){
    const tr=document.createElement('tr');
    const f = getUnit(cat, from), t = getUnit(cat, to);
    const numVal = parseFloat(val);
    const res = isFinite(numVal) ? convertOnce(numVal,cat,from,to) : NaN;
    tr.innerHTML = `
      <td class="mono">${escapeHtml(String(val))}</td>
      <td>${from} <span class="small muted">(${f?.name||''})</span></td>
      <td>${to} <span class="small muted">(${t?.name||''})</span></td>
      <td class="mono">${isFinite(res)?fmt(res):'—'}</td>
      <td class="right"><button class="btn btn-ghost" title="Remove">✕</button></td>
    `;
    tr.querySelector('button').onclick=()=>tr.remove();
    $('#tbody').prepend(tr);
  }

  function escapeHtml(s){
    return s.replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function doConvert(){
    const v = parseFloat($('#value').value);
    const cat = catSel.value; const from=fromSel.value; const to=toSel.value;
    if(isNaN(v)){ note('Enter a numeric value to convert.'); return; }
    try{
      const out = convertOnce(v, cat, from, to);
      note(`${fmt(v)} ${from} = ${fmt(out)} ${to}`);
      addLine(v,cat,from,to);
    }catch(err){ note(`Conversion error: ${err.message}`); }
  }

  function swap(){
    const a = fromSel.value, b = toSel.value; fromSel.value=b; toSel.value=a; paintStar();
  }

  function copyAll(){
    const TAB = String.fromCharCode(9);
    const NL = String.fromCharCode(10);
    const rows = $$('#tbody tr').map(tr=>
      $$('.mono', tr).map(td=>td.textContent).join(TAB) + TAB +
      $$('.small', tr).map(s=>s.textContent.replace(/[()]/g,'').trim()).join(TAB)
    );
    const text = rows.join(NL);
    navigator.clipboard.writeText(text).then(()=>{
      note(`Copied ${rows.length} line(s) to clipboard.`);
    },()=>{
      note('Copy failed. You can still select and copy manually.');
    });
  }

  // Wire events
  $('#convert').onclick = doConvert;
  $('#swap').onclick = swap;
  $('#star').onclick = toggleFav;
  $('#addRow').onclick = ()=>addLine($('#value').value || '—', catSel.value, fromSel.value, toSel.value);
  $('#clearRows').onclick = ()=>{ $('#tbody').innerHTML=''; };
  $('#copyAll').onclick = copyAll;
  $('#incPrec').onclick = ()=>setPrec(sigFigs+1);
  $('#decPrec').onclick = ()=>setPrec(sigFigs-1);
  $('#search').addEventListener('input', e=>searchUnits(e.target.value));

  // Enter key
  $('#value').addEventListener('keydown', e=>{ if(e.key==='Enter') doConvert(); });

  // Initialize
  catSel.onchange = ()=>{ loadUnits(catSel.value); paintStar(); };
  fromSel.onchange = paintStar; toSel.onchange = paintStar;
  catSel.value = 'Length'; loadUnits('Length'); paintStar();
  renderFavs();

  // Starter hint
  note('Examples: 1) 120 MBH → kW; 2) 6000 cfm → L/s; 3) 1.5 in/ft → % grade; 4) 500 bf → ft³; 5) 24 R → RSI.');
})();
</script>
</body>
</html>
