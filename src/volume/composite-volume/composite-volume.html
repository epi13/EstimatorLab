<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Composite 3D Volume from Orthogonal Wireframes</title>
<link rel="stylesheet" href="../styles.css">
<style>
  /* Additional styles can be added here if needed */
</style>
</head>
<body>

<!-- LEFT: Controls -->
<div class="panel left">
  <h1>Composite 3D Volume (Orthogonal Sections)</h1>

  <div class="group">
    <h2>1) Load Backdrops (PDF or Image)</h2>
    <label>View A backdrop (PDF page or image)
      <input id="fileA" type="file" accept="application/pdf,image/*" />
    </label>
    <div class="row">
      <input id="pageA" type="number" min="1" value="1" />
      <button id="renderA">Render A</button>
    </div>
    <label>View B backdrop (PDF page or image)
      <input id="fileB" type="file" accept="application/pdf,image/*" />
    </label>
    <div class="row">
      <input id="pageB" type="number" min="1" value="1" />
      <button id="renderB">Render B</button>
    </div>
    <div class="row">
      <label>Backdrop scale A
        <input id="scaleA" type="range" min="0.2" max="3" step="0.01" value="1" />
      </label>
      <label>Backdrop scale B
        <input id="scaleB" type="range" min="0.2" max="3" step="0.01" value="1" />
      </label>
    </div>
    <div class="row">
      <button id="toggleGridA">Toggle Grid A</button>
      <button id="toggleGridB">Toggle Grid B</button>
    </div>
  </div>

  <div class="group">
    <h2>2) Unit Calibration</h2>
    <div class="tiny">Use the <span class="kbd">Calibrate</span> tool: draw a reference segment on each view and enter its real length.</div>
    <div class="row">
      <label>Units
        <select id="units">
          <option value="ft">Feet</option>
          <option value="in">Inches</option>
          <option value="m">Meters</option>
          <option value="cm">Centimeters</option>
        </select>
      </label>
      <label>Z axis units
        <select id="zunits">
          <option value="ft">Feet</option>
          <option value="in">Inches</option>
          <option value="m">Meters</option>
          <option value="cm">Centimeters</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Cal length A (<span id="unitsA">ft</span>)
        <input id="calLenA" type="number" min="0" step="0.0001" value="0" />
      </label>
      <label>Cal length B (<span id="unitsB">ft</span>)
        <input id="calLenB" type="number" min="0" step="0.0001" value="0" />
      </label>
    </div>
  </div>

  <div class="group">
    <h2>3) Volume Settings</h2>
    <div class="row">
      <label>Extent X (<span id="ux">ft</span>)
        <input id="extentX" type="number" step="0.001" value="10" />
      </label>
      <label>Extent Y (<span id="uy">ft</span>)
        <input id="extentY" type="number" step="0.001" value="10" />
      </label>
    </div>
    <div class="row">
      <label>Extent Z (<span id="uz">ft</span>)
        <input id="extentZ" type="number" step="0.001" value="10" />
      </label>
      <label>Voxel Resolution (N³)
        <input id="voxN" type="number" min="10" max="160" step="1" value="60" />
      </label>
    </div>
    <button id="compute" class="accent">Compute Volume</button>
    <div class="footer-note tiny">Tip: Start with N=40–80 for speed. Increase for accuracy.</div>
  </div>

  <div class="group">
    <h2>4) Save / Load</h2>
    <div class="row">
      <button id="exportJSON" class="good">Export Shapes JSON</button>
      <button id="importJSON" class="warn">Import Shapes JSON</button>
    </div>
    <input id="jsonFile" type="file" accept="application/json" style="display:none" />
  </div>
</div>

<!-- CENTER: Drawing Area -->
<div class="panel center">
  <div class="view-tabs">
    <button class="tab-btn active" data-view="A">View A (X–Z)</button>
    <button class="tab-btn" data-view="B">View B (Y–Z)</button>
    <span class="pill">Tools:
      <button class="tool" data-tool="select">Select/Drag</button>
      <button class="tool" data-tool="add">Add Node</button>
      <button class="tool" data-tool="close">Close Poly</button>
      <button class="tool" data-tool="cal">Calibrate</button>
      <button class="tool danger" data-tool="clear">Clear</button>
    </span>
    <span class="pill">Snap: <input id="snap" type="checkbox" /> grid</span>
  </div>

  <div class="canvas-wrap" id="workarea">
    <!-- Backdrop (PDF/Image) -->
    <canvas class="layer" id="bgCanvas"></canvas>
    <!-- Grid -->
    <canvas class="layer" id="gridCanvas"></canvas>
    <!-- Wireframe SVG -->
    <svg class="layer" id="svgLayer"></svg>
    <!-- Toolbar readouts -->
    <div class="toolbar">
      <span class="pill">View: <strong id="whichView">A</strong></span>
      <span class="pill">Nodes: <span id="nodeCount">0</span></span>
      <span class="pill">Area: <span id="areaOut">0.000</span> <span id="areaUnits">ft²</span></span>
    </div>
  </div>
</div>

<!-- RIGHT: Results -->
<div class="panel right">
  <h2>Areas & Volume</h2>
  <div class="stat" id="stats">
    <div><strong>View A Area:</strong> <span id="areaA">0.000</span> <span id="uAreaA">ft²</span></div>
    <div><strong>View B Area:</strong> <span id="areaB">0.000</span> <span id="uAreaB">ft²</span></div>
    <hr style="border-color:#334155; margin:8px 0;">
    <div><strong>Voxel Count (solid):</strong> <span id="voxCount">0</span></div>
    <div><strong>Voxel Size:</strong> <span id="voxSize" class="mono">—</span></div>
    <div><strong>Estimated Volume:</strong> <span id="volOut">0.000</span> <span id="volUnits">ft³</span></div>
  </div>

  <h2 style="margin-top:18px;">Notes</h2>
  <ul class="tiny" style="margin-top:6px; line-height:1.35;">
    <li>View A is interpreted as an <strong>X–Z</strong> section; View B as a <strong>Y–Z</strong> section.</li>
    <li>Calibrate each view so pixels ⇄ units are correct (draw the orange ref line, enter real length).</li>
    <li>Snap to grid for crisp tracing; adjust backdrop scale sliders to match your page scale.</li>
    <li>Increase N for higher fidelity; volume converges as N → large.</li>
  </ul>
</div>

<!-- PDF.js (UMD) for in-browser PDF rendering; works offline once cached) -->
<!-- If a CDN is blocked in your environment, optionally download pdf.min.js and pdf.worker.min.js and reference them locally. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-9GdYyLiVgJ2I6v7hAQcQB6+3qfZ0HcvoDno4chZ5+acR3KQQl1yTzJn62K0E0eK8C05iW4bD7p2C0o6aJ3Q0Lw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  // Configure worker for this version
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }
</script>

<script src="composite-volume.js"></script>
</body>
</html>
